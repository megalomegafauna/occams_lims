<html i18n:domain="occams_lims" metal:use-macro="load:../master.pt">
  <metal:content-slot fill-slot="content-slot">

    <header class="page-header">
      <h1>${context.title}</h1>
      <nav metal:use-macro="load: ../header-nav.pt"></nav>
    </header>

    <form metal:use-macro="load: ../aliquot/filter-aliquot.pt"></form>

    <hr />

    <div class="well well-lg" tal:condition="not:has_aliquot">
      <h3 i18n:translate="">No aliquot found</h3>
      <p i18n:translate="">Please refine your search</p>
    </div>

    <form method="POST" action="${request.current_route_path()}">
      <input type="hidden" name="csrf_token" value="${request.session.get_csrf_token()}">

      <table class="table table-bordered table-hover table-striped" tal:condition="has_aliquot">
        <colgroup>
          <col class="select"></col>
          <col class="id"></col>
          <col class="aliquot"></col>
          <col class="amount"></col>
          <col class="freezer"></col>
          <col class="rack"></col>
          <col class="box"></col>
          <col class="thaw_count"></col>
          <col class="previous_location"></col>
          <col class="notes"></col>
        </colgroup>
        <thead>
          <tr>
            <th><input type="checkbox" data-toggle='selectall'/></th>
            <th i18n:translate="">ID</th>
            <th i18n:translate="">Aliquot</th>
            <th i18n:translate="" class="required">Amount</th>
            <th i18n:translate="">Freezer</th>
            <th i18n:translate="">Rack</th>
            <th i18n:translate="">Row/Column/Box</th>
            <th i18n:translate="">Thawed Count</th>
            <th i18n:translate="">Location</th>
            <th i18n:translate="">Notes</th>
          </tr>
        </thead>
        <tbody>
          <tal:draw repeat="sample aliquot">
            <tr class="${'danger' if subform.errors else ''}"
                tal:define="
                  subform form.aliquot.entries[repeat['sample'].index]">
              <td>${subform.ui_selected(**{'data-toggle': 'select'})}</td>
              <td><code>${sample.id}</code></td>
              <td>
                <div class="pull-right"><code>${sample.collect_date}</code></div>
                <div><code>${sample.specimen.patient.pid}</code></div>
                <div><strong>${sample.specimen.cycle.study.short_title} - ${sample.specimen.cycle.week}</strong></div>
                <div>${sample.aliquot_type.title}</div>
              </td>

              <td tal:define="field subform.amount">
                <div class="input-group"
                     tal:define="units sample.aliquot_type.units"
                     tal:omit-tag="not:units">
                  ${field(class_='form-control')}
                    <span class="input-group-addon"
                          tal:condition="units"
                      ><small>${sample.aliquot_type.units}</small></span>
                </div>
                <div class="text-danger" tal:repeat="error field.errors">${error}</div>
              </td>
              <td tal:define="field subform.freezer">
                ${field(class_='form-control')}
                <div class="text-danger" tal:repeat="error field.errors">${error}</div>
              </td>
              <td tal:define="field subform.rack">
                ${field(class_='form-control')}
                <div class="text-danger" tal:repeat="error field.errors">${error}</div>
              </td>
              <td class="form-inline text-nowrap">
                  <span tal:define="field subform.box_row">
                    ${field(class_='form-control box_row', size=2)}
                    <div class="text-danger" tal:repeat="error field.errors">${error}</div>
                  </span>
                  <span tal:define="field subform.box_column">
                    ${field(class_='form-control box_column', size=2)}
                    <div class="text-danger" tal:repeat="error field.errors">${error}</div>
                  </span>
                  <span tal:define="field subform.box">
                    ${field(class_='form-control', size=2)}
                    <button
                        class="btn btn-outline-secondary"
                        id="box-modal"
                        data-remote="${request.current_route_path(_route_name='lims.boxes')}"
                        type=button">
                        View
                    </button>
                  <div class="text-danger" tal:repeat="error field.errors">${error}</div>
                  </span>
              </td>
              <td tal:define="field subform.thawed_num">
                ${field(class_='form-control')}
                <div class="text-danger" tal:repeat="error field.errors">${error}</div>
              </td>
              <td tal:define="field subform.location_id">
                ${field(class_='form-control js-select2')}
                <div class="text-danger" tal:repeat="error field.errors">${error}</div>
              </td>
              <td tal:define="field subform.notes">
                ${field(class_='form-control')}
                <div class="text-danger" tal:repeat="error field.errors">${error}</div>
              </td>

            </tr>
          </tal:draw>
        </tbody>
      </table>

      <nav metal:use-macro="load: ../pager.pt"></nav>

      <button
          type="submit"
          class="btn btn-default"
          name="pending-checkout"
          tal:condition="request.has_permission('process')"
          tal:attributes="disabled not:has_aliquot"
          >Mark Selection as Pending Check-Out</button>
      <button
          type="submit"
          class="btn btn-primary"
          name="save"
          tal:attributes="disabled not:has_aliquot"
          >Save All Changes</button>

    </form>

  </metal:content-slot>

</html>
